<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cr√©ation de Facture</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary-color: #1E40AF;
      --secondary-color: #4B5563;
      --background-color: #F3F4F6;
      --button-color: #10B981;
      --border-radius: 10px;
      --input-padding: 14px;
      --button-padding: 16px;
    }

    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--background-color);
      color: var(--secondary-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }

    .login-container {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
      transition: transform 0.3s ease;
    }

    h2 {
      color: var(--primary-color);
      font-size: 2rem;
      text-align: center;
      margin-bottom: 24px;
      text-transform: uppercase;
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--primary-color);
    }

    input, select, button {
      width: 100%;
      padding: var(--input-padding);
      margin: 10px 0;
      border-radius: var(--border-radius);
      font-size: 1rem;
      border: 1px solid #ccc;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      outline: none;
      border: 2px solid var(--primary-color);
    }

    button[type="button"], button[type="submit"] {
      background-color: var(--button-color);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
      padding: var(--button-padding);
      margin-top: 20px;
      border-radius: var(--border-radius);
    }

    button[type="button"]:hover, button[type="submit"]:hover {
      background-color: #16a34a;
    }

    .forgot-password {
      text-align: center;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    .forgot-password a {
      color: var(--primary-color);
      text-decoration: none;
    }

    .forgot-password a:hover {
      text-decoration: underline;
    }

    .loader {
      display: none;
      text-align: center;
      font-weight: bold;
      color: var(--button-color);
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .login-container {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="login-container" id="loginContainer">
    <h2>Connexion</h2>
    <form id="loginForm">
      <label for="username">Nom d'utilisateur</label>
      <input type="text" id="username" placeholder="Nom d'utilisateur" required />

      <label for="password">Mot de passe</label>
      <input type="password" id="password" placeholder="Mot de passe" required />

      <div class="forgot-password">
        <a href="#">Mot de passe oubli√© ?</a>
      </div>

      <button type="submit">Se connecter</button>
    </form>
  </div>

  <div class="container" style="display: none;" id="mainContainer">
    <h2>Cr√©ation de Facture</h2>
    <button onclick="deconnexion()">üîí D√©connexion</button>
    <!-- Formulaire pour la cr√©ation de la facture -->
    <form id="factureForm">
      <label for="type">Type</label>
      <select name="type" id="type" required>
        <option value="Facture">Facture</option>
        <option value="Devis">Devis</option>
      </select>

      <label for="numFacture">Num√©ro de Facture</label>
      <input type="text" name="numFacture" id="numFacture" required placeholder="Entrez le num√©ro de la facture" />

      <label for="date">Date</label>
      <input type="date" name="date" id="date" required />

      <label for="client">Client</label>
      <textarea name="client" id="client" rows="6" required placeholder="D√©tails relatifs au client..."></textarea>

      <label for="devise">Devise</label>
      <select name="devise" id="devise" required onchange="mettreAJourTotaux()">
        <option value="‚Ç¨">‚Ç¨</option>
        <option value="DH" selected>DH</option>  <!-- DH s√©lectionn√© par d√©faut -->
      </select>

      <label for="tva">TVA (%)</label>
      <input type="number" name="tva" id="tva" value="20" required onchange="mettreAJourTotaux()" />

      <label for="lignes"></label>
      <table id="lignesTable">
        <thead>
          <tr><th>D√©signation</th><th>Prix Unitaire</th><th>Quantit√©</th><th>Actions</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="text" name="designation" required /></td>
            <td><input type="number" name="prix" step="0.01" required oninput="mettreAJourTotaux()" /></td>
            <td><input type="number" name="quantite" required oninput="mettreAJourTotaux()" /></td>
            <td><button type="button" onclick="supprimerLigne(this)">Supprimer</button></td>
          </tr>
        </tbody>
      </table>
      <button type="button" onclick="ajouterLigne()">‚ûï Ajouter une ligne</button>
      <div id="total"></div>
      <div class="button-group">
        <button type="submit" id="submitBtn">G√©n√©rer Facture</button>
        <button type="button" id="btnTelecharger" disabled>üì• T√©l√©charger PDF</button>
        <button type="button" onclick="reinitialiserFormulaire()">üÜï Nouvelle facture</button>
        <label for="logoUpload">üì∑ Ajouter un logo</label>
        <input type="file" id="logoUpload" accept="image/*" onchange="chargerLogo(event)" />
      </div>
    </form>
    <div class="button-group">
      <button type="button" onclick="afficherFormEntreprise()">üñãÔ∏è Informations sur le vendeur</button>
    </div>
    <div class="entreprise-info" id="entrepriseInfoForm">
      <label for="nomEntreprise">Informations sur le vendeur</label>
      <textarea id="nomEntreprise" rows="4" placeholder="Saisir les informations du vendeur..."></textarea>
      <button type="button" onclick="enregistrerEntreprise()">Enregistrer</button>
    </div>
    <div class="loader" id="loader">Veuillez patienter, la g√©n√©ration de la facture est en cours...</div>
  </div>

  <!-- Copyright Section -->
  <div class="copyright">
    <p>&copy; 2025 GetQuick. +212630230803.</p>
  </div>

  <script>
    // Fonction pour afficher la notification Toast
    function afficherToast(message) {
      const toast = document.getElementById('toastMessage');
      const toastText = document.getElementById('toastText');
      toastText.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000); // La notification dispara√Æt apr√®s 3 secondes
    }

    function protegerAcces() {
      const estConnecte = sessionStorage.getItem('connecte');
      if (!estConnecte) {
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
      } else {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
      }
    }

    let logoImageBase64 = null;

    function verifierLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const rememberMe = document.getElementById('rememberMe').checked;

      const identifiantsValides = {
        'demo': '3388',
        'mounir': '3388'
      };

      if (identifiantsValides[username] && identifiantsValides[username] === password) {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        afficherToast("Connexion r√©ussie !");

        sessionStorage.setItem('connecte', 'true');
        protegerAcces();

        if (rememberMe) {
          localStorage.setItem('username', username);
          localStorage.setItem('password', password);
        } else {
          localStorage.removeItem('username');
          localStorage.removeItem('password');
        }
      } else {
        afficherToast("Nom d'utilisateur ou mot de passe incorrect.");
      }
    }

    window.onload = function() {
      const savedUsername = localStorage.getItem('username');
      const savedPassword = localStorage.getItem('password');
      if (savedUsername && savedPassword) {
        document.getElementById('username').value = savedUsername;
        document.getElementById('password').value = savedPassword;
        document.getElementById('rememberMe').checked = true;
      }
      protegerAcces();
    };

    function chargerLogo(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        logoImageBase64 = e.target.result;
        afficherToast("Logo charg√© avec succ√®s !");
      };
      reader.readAsDataURL(file);
    }

    function enregistrerEntreprise() {
      const entrepriseInfo = {
        nom: document.getElementById('nomEntreprise').value
      };
      localStorage.setItem('entrepriseInfo', JSON.stringify(entrepriseInfo));

      afficherToast("Information enregistr√©e avec succ√®s !");
    }

    function ajouterLigne() {
      const table = document.getElementById('lignesTable').getElementsByTagName('tbody')[0];
      const row = table.insertRow();
      row.innerHTML = `<td><input type="text" name="designation" required></td>
                       <td><input type="number" name="prix" step="0.01" required oninput="mettreAJourTotaux()"></td>
                       <td><input type="number" name="quantite" required oninput="mettreAJourTotaux()"></td>
                       <td><button type="button" onclick="supprimerLigne(this)">Supprimer</button></td>`;
    }

    function supprimerLigne(btn) {
      const row = btn.parentNode.parentNode;
      row.parentNode.removeChild(row);
      mettreAJourTotaux();
    }

    function mettreAJourTotaux() {
      let totalHT = 0;
      const rows = document.getElementById('lignesTable').getElementsByTagName('tbody')[0].rows;
      for (let row of rows) {
        const prix = parseFloat(row.cells[1].querySelector('input').value) || 0;
        const quantite = parseInt(row.cells[2].querySelector('input').value) || 0;
        if (prix <= 0 || quantite <= 0) continue;
        totalHT += prix * quantite;
      }
      const tva = parseFloat(document.getElementById('tva').value) || 20;
      const totalTTC = totalHT * (1 + tva / 100);
      const devise = document.getElementById('devise').value;
      document.getElementById('total').innerHTML = `Total HT : ${totalHT.toFixed(2)} ${devise} <br>
                                                    TVA (${tva}%) : ${(totalHT * (tva / 100)).toFixed(2)} ${devise} <br>
                                                    Total TTC : ${totalTTC.toFixed(2)} ${devise}`;
    }

    document.getElementById('factureForm').onsubmit = function(event) {
      event.preventDefault();
      const form = event.target;
      const data = {
        type: form.type.value,
        date: form.date.value,
        numFacture: form.numFacture.value,  // Ajout du num√©ro de facture
        client: form.client.value,
        devise: form.devise.value,
        tva: form.tva.value,
        lignes: []
      };

      const rows = document.getElementById('lignesTable').getElementsByTagName('tbody')[0].rows;
      for (let row of rows) {
        const nom = row.cells[0].querySelector('input').value.trim();
        const prix = parseFloat(row.cells[1].querySelector('input').value);
        const qte = parseInt(row.cells[2].querySelector('input').value);
        if (!nom || isNaN(prix) || isNaN(qte)) continue;
        data.lignes.push({ nom, prix, qte });
      }

      const entrepriseInfo = JSON.parse(localStorage.getItem('entrepriseInfo'));
      if (entrepriseInfo) data.entreprise = entrepriseInfo;
      localStorage.setItem('factureData', JSON.stringify(data));

      afficherToast("Facture g√©n√©r√©e avec succ√®s !");
      document.getElementById('btnTelecharger').disabled = false;
    };

    document.getElementById('btnTelecharger').onclick = function() {
      const factureData = JSON.parse(localStorage.getItem('factureData'));
      if (!factureData) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      if (logoImageBase64) {
        doc.addImage(logoImageBase64, 'PNG', 10, 6, 30, 30); // x, y, largeur, hauteur
      }

      const title = factureData.type === "Facture" ? "FACTURE" : "DEVIS";

      let titleYPos = 40; 
      doc.setFontSize(30);
      doc.setFont("helvetica", "bold");
      doc.text(title, 105, titleYPos, { align: "center" });

      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");
      doc.text(`Num√©ro de Facture : ${factureData.numFacture}`, 14, titleYPos + 10);
      const dateLabel = factureData.type === "Facture" ? "Date de la facture" : "Date de devis";
      doc.text(`${dateLabel} : ${factureData.date}`, 14, titleYPos + 15);

      const lignesClient = factureData.client.split('\n').filter(l => l.trim() !== '');
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("Informations client :", 14, titleYPos + 25);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);

      let yPos = titleYPos + 35;
      const ligneHeight = 6;
      lignesClient.forEach(ligne => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        doc.text(ligne, 20, yPos);
        yPos += ligneHeight;
      });

      const entrepriseInfo = JSON.parse(localStorage.getItem('entrepriseInfo'));
      if (entrepriseInfo) {
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("Informations sur le vendeur :", 14, yPos + 10);
        yPos += 20;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        const lignesEntreprise = entrepriseInfo.nom.split('\n').filter(l => l.trim() !== '');
        lignesEntreprise.forEach(ligne => {
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
          doc.text(ligne, 20, yPos);
          yPos += ligneHeight;
        });
      }

      doc.autoTable({
        startY: yPos + 10,
        head: [['Description', `Prix Unitaire (${factureData.devise})`, 'Quantit√©', `Total (${factureData.devise})`]], 
        body: factureData.lignes.map(ligne => [
          ligne.nom, 
          `${ligne.prix.toFixed(2)} ${factureData.devise}`, 
          ligne.qte,  
          `${(ligne.prix * ligne.qte).toFixed(2)} ${factureData.devise}`
        ]),
        styles: { 
          cellPadding: 4,
          lineColor: [200, 200, 200],
          lineWidth: 0.1,
          fontSize: 10,
          cellWidth: 'auto',
        },
        theme: 'grid',
        margin: { top: 10, bottom: 20 },
        tableWidth: 'auto',
      });

      const totalHT = factureData.lignes.reduce((acc, ligne) => acc + (ligne.prix * ligne.qte), 0);
      const tva = totalHT * (factureData.tva / 100);
      const totalTTC = totalHT + tva;
      doc.setFont("helvetica", "bold");
      doc.text(`Sous-total HT : ${totalHT.toFixed(2)} ${factureData.devise}`, 14, doc.lastAutoTable.finalY + 20);
      doc.text(`TVA (${factureData.tva}%) : ${tva.toFixed(2)} ${factureData.devise}`, 14, doc.lastAutoTable.finalY + 30);
      doc.text(`Total TTC : ${totalTTC.toFixed(2)} ${factureData.devise}`, 14, doc.lastAutoTable.finalY + 40);

      doc.save(`${factureData.client}_facture.pdf`);
    };

    function afficherFormEntreprise() {
      const form = document.getElementById('entrepriseInfoForm');
      form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
    }

    function deconnexion() {
      sessionStorage.removeItem('connecte');
      localStorage.removeItem('username');
      localStorage.removeItem('password');
      location.reload();
    }

    function reinitialiserFormulaire() {
      document.getElementById('factureForm').reset();
      localStorage.removeItem('factureData');
      document.getElementById('btnTelecharger').disabled = true;
      const tbody = document.getElementById('lignesTable').getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      ajouterLigne();
      mettreAJourTotaux();
    }

    mettreAJourTotaux();
  </script>
</body>
</html>
