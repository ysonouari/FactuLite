<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.5" />
  <title>Cr√©ation de Facture</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary-color: #1E40AF;
      --secondary-color: #4B5563;
      --background-color: #F3F4F6;
      --accent-color: #10B981;
      --button-color: #F3F4F6;
      --border-radius: 10px;
      --input-padding: 12px;
      --button-padding: 15px;
    }

    input, select, textarea {
      font-size: 16px;
    }

    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--background-color);
      color: var(--secondary-color);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 30px;
      width: 100%;
      max-width: 800px;
      box-sizing: border-box;
      margin: 0 15px;
    }

    h2 {
      color: var(--primary-color);
      font-size: 2rem;
      text-align: center;
      margin-bottom: 20px;
      text-transform: uppercase;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 1.1rem;
    }

    input, select, button {
      width: 100%;
      padding: var(--input-padding);
      margin: 10px 0;
      border-radius: var(--border-radius);
      font-size: 1rem;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      outline: none;
      border: 2px solid var(--primary-color);
    }

    button[type="button"], button[type="submit"] {
      background-color: var(--button-color);
      color: var(--secondary-color);
      border: 1px solid #D1D5DB;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }

    button[type="button"]:hover, button[type="submit"]:hover {
      background-color: var(--accent-color);
      color: white;
    }

    .button-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .loader {
      display: none;
      text-align: center;
      font-weight: bold;
      color: var(--accent-color);
      margin-top: 20px;
    }

    #total {
      font-weight: 600;
      margin-top: 10px;
      color: var(--primary-color);
    }

    .entreprise-info {
      background-color: #F9FAFB;
      padding: 15px;
      margin-top: 20px;
      border-radius: var(--border-radius);
      display: none;
      transition: all 0.3s ease;
    }

    .entreprise-info input {
      margin-bottom: 10px;
    }

    /* Styling for the login container */
    .login-container {
      background-color: #fff;
      border-radius: var(--border-radius);
      padding: 30px;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .login-container h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    .login-container input {
      width: 100%;
      margin-bottom: 20px;
    }

    .login-container button {
      background-color: var(--accent-color);
      color: white;
      font-weight: bold;
      padding: 12px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .login-container button:hover {
      background-color: var(--primary-color);
    }

    .login-container input[type="checkbox"] {
      margin-right: 10px;
    }

    /* Toast Notification Style */
    .toast {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background-color: #4CAF50;
      color: white;
      text-align: center;
      border-radius: 2px;
      padding: 16px;
      position: fixed;
      z-index: 1;
      left: 50%;
      top: 50%;
      font-size: 17px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: visibility 0.5s, opacity 0.5s ease-in-out;
    }

    .toast.show {
      visibility: visible;
      opacity: 1;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      h2 {
        font-size: 1.5rem;
      }
    }

    /* Styling for copyright */
    .copyright {
      position: fixed;
      bottom: 0;
      right: 0;
      font-size: 1rem;
      color: #4B5563;
      text-align: right;
      padding: 10px;
      width: auto;
    }
  </style>
</head>
<body>
  <!-- Toast Notification -->
  <div id="toastMessage" class="toast">
    <p id="toastText"></p>
  </div>

  <div class="login-container" id="loginContainer">
    <h2>Connexion</h2>
    <input type="text" id="username" placeholder="Nom d'utilisateur" required />
    <input type="password" id="password" placeholder="Mot de passe" required />
    <div>
      <input type="checkbox" id="rememberMe" />
      <label for="rememberMe">Se souvenir de moi</label>
    </div>
    <button onclick="verifierLogin()">Se connecter</button>
  </div>

  <div class="container" style="display: none;" id="mainContainer">
    <h2>Cr√©ation de Facture</h2>
    <button onclick="deconnexion()">üîí D√©connexion</button>
    <form id="factureForm">
      <!-- Le reste de ton formulaire ici -->
    </form>
  </div>

  <!-- Copyright Section -->
  <div class="copyright">
    <p>&copy; 2025 GetQuick. +212630230803.</p>
  </div>

  <script>
    // Fonction pour afficher la notification Toast
    function afficherToast(message) {
      const toast = document.getElementById('toastMessage');
      const toastText = document.getElementById('toastText');
      toastText.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000); // La notification dispara√Æt apr√®s 3 secondes
    }

    function protegerAcces() {
      const estConnecte = sessionStorage.getItem('connecte');
      if (!estConnecte) {
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
      } else {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
      }
    }

    let logoImageBase64 = null;
    
    // V√©rifier si l'utilisateur a coch√© "Remember me" et s'il a des informations sauvegard√©es
    function verifierLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const rememberMe = document.getElementById('rememberMe').checked;

      const identifiantsValides = {
        'demo': '3388',
        'mounir': '3388'
      };

      // Si les identifiants sont valides
      if (identifiantsValides[username] && identifiantsValides[username] === password) {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        afficherToast("Connexion r√©ussie !");

        sessionStorage.setItem('connecte', 'true');
        protegerAcces();

        // Si "Remember me" est coch√©, on stocke les informations dans localStorage
        if (rememberMe) {
          localStorage.setItem('username', username);
          localStorage.setItem('password', password);
        } else {
          // Si "Remember me" n'est pas coch√©, on efface les donn√©es stock√©es (si pr√©sentes)
          localStorage.removeItem('username');
          localStorage.removeItem('password');
        }
      } else {
        afficherToast("Nom d'utilisateur ou mot de passe incorrect.");
      }
    }

    // Lors du chargement de la page, v√©rifier si les donn√©es sont d√©j√† stock√©es
    window.onload = function() {
      const savedUsername = localStorage.getItem('username');
      const savedPassword = localStorage.getItem('password');
      if (savedUsername && savedPassword) {
        document.getElementById('username').value = savedUsername;
        document.getElementById('password').value = savedPassword;
        document.getElementById('rememberMe').checked = true;
      }
      protegerAcces(); // <--- ajoute ceci ici
    };

    function chargerLogo(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        logoImageBase64 = e.target.result;
        afficherToast("Logo charg√© avec succ√®s !");
      };
      reader.readAsDataURL(file);
    }

    function enregistrerEntreprise() {
      const entrepriseInfo = {
        nom: document.getElementById('nomEntreprise').value
      };
      localStorage.setItem('entrepriseInfo', JSON.stringify(entrepriseInfo));

      afficherToast("Information enregistr√©e avec succ√®s !");
    }

    function ajouterLigne() {
      const table = document.getElementById('lignesTable').getElementsByTagName('tbody')[0];
      const row = table.insertRow();
      row.innerHTML = `<td><input type="text" name="designation" required></td>
                       <td><input type="number" name="prix" step="0.01" required oninput="mettreAJourTotaux()"></td>
                       <td><input type="number" name="quantite" required oninput="mettreAJourTotaux()"></td>
                       <td><button type="button" onclick="supprimerLigne(this)">Supprimer</button></td>`;
    }

    function supprimerLigne(btn) {
      const row = btn.parentNode.parentNode;
      row.parentNode.removeChild(row);
      mettreAJourTotaux();
    }

    function mettreAJourTotaux() {
      let totalHT = 0;
      const rows = document.getElementById('lignesTable').getElementsByTagName('tbody')[0].rows;
      for (let row of rows) {
        const prix = parseFloat(row.cells[1].querySelector('input').value) || 0;
        const quantite = parseInt(row.cells[2].querySelector('input').value) || 0;
        if (prix <= 0 || quantite <= 0) continue;
        totalHT += prix * quantite;
      }
      const tva = parseFloat(document.getElementById('tva').value) || 20;
      const totalTTC = totalHT * (1 + tva / 100);
      const devise = document.getElementById('devise').value;
      document.getElementById('total').innerHTML = `Total HT : ${totalHT.toFixed(2)} ${devise} <br>
                                                    TVA (${tva}%) : ${(totalHT * (tva / 100)).toFixed(2)} ${devise} <br>
                                                    Total TTC : ${totalTTC.toFixed(2)} ${devise}`;
    }

    document.getElementById('factureForm').onsubmit = function(event) {
      event.preventDefault();
      const form = event.target;
      const data = {
        type: form.type.value,
        date: form.date.value,
        numFacture: form.numFacture.value,  // Ajout du num√©ro de facture
        client: form.client.value,
        devise: form.devise.value,
        tva: form.tva.value,
        lignes: []
      };

      const rows = document.getElementById('lignesTable').getElementsByTagName('tbody')[0].rows;
      for (let row of rows) {
        const nom = row.cells[0].querySelector('input').value.trim();
        const prix = parseFloat(row.cells[1].querySelector('input').value);
        const qte = parseInt(row.cells[2].querySelector('input').value);
        if (!nom || isNaN(prix) || isNaN(qte)) continue;
        data.lignes.push({ nom, prix, qte });
      }

      const entrepriseInfo = JSON.parse(localStorage.getItem('entrepriseInfo'));
      if (entrepriseInfo) data.entreprise = entrepriseInfo;
      localStorage.setItem('factureData', JSON.stringify(data));

      afficherToast("Facture g√©n√©r√©e avec succ√®s !");
      document.getElementById('btnTelecharger').disabled = false;
    };

    document.getElementById('btnTelecharger').onclick = function() {
      const factureData = JSON.parse(localStorage.getItem('factureData'));
      if (!factureData) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Ajout du logo en haut √† gauche
      if (logoImageBase64) {
        doc.addImage(logoImageBase64, 'PNG', 10, 6, 30, 30); // x, y, largeur, hauteur
      }

      const title = factureData.type === "Facture" ? "FACTURE" : "DEVIS";

      // Cr√©e un saut de 4 lignes apr√®s le logo
      let titleYPos = 40; // Position apr√®s 4 lignes de saut (environ 10mm par ligne)
      doc.setFontSize(30);
      doc.setFont("helvetica", "bold");
      doc.text(title, 105, titleYPos, { align: "center" });

      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");
      doc.text(`Num√©ro de Facture : ${factureData.numFacture}`, 14, titleYPos + 10);
      const dateLabel = factureData.type === "Facture" ? "Date de la facture" : "Date de devis";
      doc.text(`${dateLabel} : ${factureData.date}`, 14, titleYPos + 15);

      const lignesClient = factureData.client.split('\n').filter(l => l.trim() !== '');
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("Informations client :", 14, titleYPos + 25);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);

      let yPos = titleYPos + 35;
      const ligneHeight = 6;
      lignesClient.forEach(ligne => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        doc.text(ligne, 20, yPos);
        yPos += ligneHeight;
      });

      const entrepriseInfo = JSON.parse(localStorage.getItem('entrepriseInfo'));
      if (entrepriseInfo) {
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("Informations sur le vendeur :", 14, yPos + 10);
        yPos += 20;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        const lignesEntreprise = entrepriseInfo.nom.split('\n').filter(l => l.trim() !== '');
        lignesEntreprise.forEach(ligne => {
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
          doc.text(ligne, 20, yPos);
          yPos += ligneHeight;
        });
      }

      doc.autoTable({
        startY: yPos + 10,
        head: [['Description', `Prix Unitaire (${factureData.devise})`, 'Quantit√©', `Total (${factureData.devise})`]], 
        body: factureData.lignes.map(ligne => [
          ligne.nom, 
          `${ligne.prix.toFixed(2)} ${factureData.devise}`, 
          ligne.qte,  
          `${(ligne.prix * ligne.qte).toFixed(2)} ${factureData.devise}` 
        ]),
        styles: { 
          cellPadding: 4,
          lineColor: [200, 200, 200],
          lineWidth: 0.1,
          fontSize: 10,
          cellWidth: 'auto',
        },
        theme: 'grid',
        margin: { top: 10, bottom: 20 },
        tableWidth: 'auto',
      });

      const totalHT = factureData.lignes.reduce((acc, ligne) => acc + (ligne.prix * ligne.qte), 0);
      const tva = totalHT * (factureData.tva / 100);
      const totalTTC = totalHT + tva;
      doc.setFont("helvetica", "bold");
      doc.text(`Sous-total HT : ${totalHT.toFixed(2)} ${factureData.devise}`, 14, doc.lastAutoTable.finalY + 20);
      doc.text(`TVA (${factureData.tva}%) : ${tva.toFixed(2)} ${factureData.devise}`, 14, doc.lastAutoTable.finalY + 30);
      doc.text(`Total TTC : ${totalTTC.toFixed(2)} ${factureData.devise}`, 14, doc.lastAutoTable.finalY + 40);

      doc.save(`${factureData.client}_facture.pdf`);
    };

    function afficherFormEntreprise() {
      const form = document.getElementById('entrepriseInfoForm');
      form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
    }

    function deconnexion() {
      sessionStorage.removeItem('connecte');
      localStorage.removeItem('username');
      localStorage.removeItem('password');
      location.reload();
    }

    function reinitialiserFormulaire() {
      document.getElementById('factureForm').reset();
      localStorage.removeItem('factureData');
      document.getElementById('btnTelecharger').disabled = true;
      const tbody = document.getElementById('lignesTable').getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      ajouterLigne();
      mettreAJourTotaux();
    }

    mettreAJourTotaux();
  </script>
</body>
</html>
